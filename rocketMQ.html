<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>RocketMQ&nbsp;|&nbsp;NorthWind</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="RocketMQ">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🚀&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="learn.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🗒️&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>Learning Notes</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about-me-569345.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🎖️&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About Me</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🚀&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">RocketMQ</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, Jun 24, 2022</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/learning.html">learning</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/a8b1557e8df34aab8a34f208f26dbbdd" class="PageRoot"><div id="https://www.notion.so/77057a992e7f4fd4aa5f347d961fd89b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Time </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Date">@2022/06/23</span></span><span class="SemanticString"> </span></span></p></div><div id="https://www.notion.so/d14c67f2f40b4a86a39d944531e476b2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/2029ec4f454f43deb9fd11f918fcfd8f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">使用消息队列的好处：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/e26dc1203c6643bdb8bf13c1f58ebcf1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">异步：实际上整个流程的时间没有减少，但是通过消息队列，使整条业务线划分成了一段一段。我的理解是，</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">和工业生产的流水线原理类似。</strong></span></span></li><li id="https://www.notion.so/31e1584bb4a8495395c1ad30cd03a57d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">解耦：如果没有消息队列，每当一个新的业务接入，我们都要在主系统调用新接口、或者当我们取消某些业务，我们也得在主系统删除某些接口调用。有了消息队列，我们只需要关心消息是否送达了队列，至于谁希望订阅，接下来收到消息如何处理，是下游的事情，无疑极大地减少了开发和联调的工作量。</span></span></li><li id="https://www.notion.so/5d8a11dc1eae4c0e92585c057fc6f0df" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">削峰：主业务服务器配置一般比较好，通过消息队列，可以防止下游业务被干掉。</span></span></li></ul><div id="https://www.notion.so/cacad56a65164a698372f3d9bb347da2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/99fba700c75e4ab98cfe0006d0d2ea3b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">采用了发布订阅模型：</span></span></p></div><div id="https://www.notion.so/275367befef4443096b09789c65060b7" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0c51a7c7-8169-4e41-80b1-8d0eeec9e53e%2FUntitled.png?width=760&amp;table=block&amp;id=275367be-fef4-4430-96b0-9789c65060b7"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0c51a7c7-8169-4e41-80b1-8d0eeec9e53e%2FUntitled.png?width=760&amp;table=block&amp;id=275367be-fef4-4430-96b0-9789c65060b7" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/a5ac9a8473c04bdebbe76c168a6d514b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/48b1ffef43634230b654c5580ecf303b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RocketMQ中的消息模型：</span></span></p></div><div id="https://www.notion.so/0778000858874f9ebf17d96e4d0c2fcb" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F263a3850-5697-438e-bd7b-b1b8e4358051%2FUntitled.png?width=1391&amp;table=block&amp;id=07780008-5887-4f9e-bf17-d96e4d0c2fcb"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F263a3850-5697-438e-bd7b-b1b8e4358051%2FUntitled.png?width=1391&amp;table=block&amp;id=07780008-5887-4f9e-bf17-d96e4d0c2fcb" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/85cc016bc30649f9962d056d0948e294" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RocketMQ中的基本概念：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/3b7afd122ec34b3ea835b293aeb9da33" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Broker：代理服务器，即消息队列服务器。一个Topic可以分布在多个Broker上，一个Broker上也可以配置多个Topic。如果Topic消息量很大，应该给它多配置几个队列（可以提高消费者的并发能力），并且尽量分布在多个broker上。</span></span></li><li id="https://www.notion.so/49c5fd9119f64b58b28645e89f17888b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Producer：生产者，一般业务系统充当生产者。</span></span></li><li id="https://www.notion.so/c798a17bf3c44b619e34b2e7932efb2e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Consumer：消费者，支持push和pull两种方式对消息进行消费。</span></span></li><li id="https://www.notion.so/32af6e6cfe5342eba360702e7118d4a3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">NameServer：类似ZooKeeper里面的注册中心（Eureka），主要提供Broker管理和路由信息管理。</span></span></li></ul><div id="https://www.notion.so/3785b7e2ddb84d8e8e748e1ab074996d" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F17aeaf01-d329-4399-9eaf-bacbfe7b6428%2FUntitled.png?width=1281&amp;table=block&amp;id=3785b7e2-ddb8-4d8e-8e74-8e1ab074996d"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F17aeaf01-d329-4399-9eaf-bacbfe7b6428%2FUntitled.png?width=1281&amp;table=block&amp;id=3785b7e2-ddb8-4d8e-8e74-8e1ab074996d" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/0fe81db599164cc9b9ccf4597d380fea" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">四个角色在RockerMQ中的架构如图所示。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/b30e616bfaac4b18b385457e7340d183" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">可以看到在broker中也做了主从部署。Slave定期从Master中同步数据（同步刷盘或者异步刷盘），Master寄了就从Slave中消费，但是Slave</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">不能写入消息</strong></span><span class="SemanticString">！</span></span></li><li id="https://www.notion.so/0dbcfe09f8aa4e2e913c858571d0b6a7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">为了保证高可用（HA，High Availablity），NameServer是</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">去中心化的</strong></span><span class="SemanticString">，没有主节点而且没有副本。单个Broker和所有NameServer保持长链接，每隔30sBroker向所有NameServer发出心跳，包含自身Topic信息。</span></span></li><li id="https://www.notion.so/e9f281eb3ec84849a89475c323e6e032" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在生产者向Broker发送消息时，需要从NameServer中获取路由信息，然后采用</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">轮询方法</strong></span><span class="SemanticString">向每隔消息队列中生产数据以达到负载均衡。</span></span></li><li id="https://www.notion.so/c68d06aebb6b47c8b3e1e33d5c7e75b4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">消费者通过NameServer获取所有Broker路由信息后，向Broker发送Pull请求来获取消息数据。Consumer有两种方式启动——广播和集群。广播模式下，一条消息会发给同一个消费组中的所有消费者，集群模式下只会发送给一个消费者。</span></span></li><li id="https://www.notion.so/2f67e53404284faaa7b40c9c990e4692" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">一个队列只会被一个消费者消费</strong></span></span></li></ul><div id="https://www.notion.so/7e0ab76f851c443488f97e0e00de6484" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/77a9f5ee6c4540edba92b79b3c3b3dc4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/77a9f5ee6c4540edba92b79b3c3b3dc4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">顺序消费</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/0396a631383145a5aaf110d9cba8277a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">严格顺序：代价很高，不怎么采用了。</span></span></li><li id="https://www.notion.so/ee554124ceb2450bade0043c1cd3daac" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">普通顺序：将同一语义下的消息放入同一个队列中，简单的hash取模即可实现。</span></span></li></ul><h3 id="https://www.notion.so/eaec2d969f7c4929aa286cd656fda7ae" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/eaec2d969f7c4929aa286cd656fda7ae"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">重复消费</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/b500bfb816a94a429ddce0af73d994a2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在客户端可以对用户的操作进行幂等校验。</span></span></li><li id="https://www.notion.so/9d54235d9ef445a592032140a0abaa57" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在消息队列中，对消费者实现幂等校验。</span></span></li></ul><div id="https://www.notion.so/eb0c7511d7594e5f84f4271ebf16f244" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/59d9dfb7db86402f83326daf9d21b8e1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/59d9dfb7db86402f83326daf9d21b8e1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">分布式事务</span></span></h3><div id="https://www.notion.so/b37fd73e3d5e489aa335959f2f97eea0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">事务要么都执行，要么都不执行。</span></span></p></div><div id="https://www.notion.so/ff5f972c2d664d55a3e8ce120e6b8922" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">分布式事务要解决事务在不同服务之间的问题。</span></span></p></div><div id="https://www.notion.so/e2575eaf95c04267ab26e062de0a350d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在RocketMQ中采用了 </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">事务消息+事务反查机制 </strong></span><span class="SemanticString">来解决分布式事务问题。</span></span></p></div><div id="https://www.notion.so/b8412c366b5148d18c743e002b57f387" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9df474fc-7578-4f18-97a5-75d1505a1648%2FUntitled.png?width=1355&amp;table=block&amp;id=b8412c36-6b51-48d1-8c74-3e002b57f387"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9df474fc-7578-4f18-97a5-75d1505a1648%2FUntitled.png?width=1355&amp;table=block&amp;id=b8412c36-6b51-48d1-8c74-3e002b57f387" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/f3beab346e054baa989efe05ff2d527a" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F62704e3c-3b94-47a2-8ce9-7f77075bb546%2FUntitled.png?width=1922&amp;table=block&amp;id=f3beab34-6e05-4baa-989e-fe05ff2d527a"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F62704e3c-3b94-47a2-8ce9-7f77075bb546%2FUntitled.png?width=1922&amp;table=block&amp;id=f3beab34-6e05-4baa-989e-fe05ff2d527a" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/d6e03a762b9d44cf9e175789d5a182fc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以此图为例说明：</span></span></p></div><div id="https://www.notion.so/e84d3370bd634bbc98c710b5f265a3a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">1.实线1向MQ发送prepare消息（此消息对消费者不可见，因此不会被消费），然后再执行producer本地事务。（只有prepare消息发送成功，本地事务才会执行）。</span></span></p></div><div id="https://www.notion.so/e77202fe4eee478a9d334214079bbd19" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">2.执行producer回调函数executeLocalTransaction()，将本地事务执行状态返回给broker。</span></span></p></div><div id="https://www.notion.so/7c02cd38bfc24a67ad8ab46714a88c6d" class="ColorfulBlock ColorfulBlock--BgOrange Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本地事务状态：</span></span></p></div><div id="https://www.notion.so/e8f2a6746f194ac9b1f64cd0a8667e06" class="ColorfulBlock ColorfulBlock--BgOrange Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">COMMIT_MESSAGE：将不可见消息变为可见</span></span></p></div><div id="https://www.notion.so/1ef9f123fcb9417e9dda09675a37c79d" class="ColorfulBlock ColorfulBlock--BgOrange Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ROLLBACK_MESSAGE：broker回收步骤1中的不可见消息</span></span></p></div><div id="https://www.notion.so/b16bf465a3654c0e963b81ac120a6487" class="ColorfulBlock ColorfulBlock--BgOrange Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">UNKNOW或者网络异常：broker调用producer中的回调函数checkLocalTransaction（）判断producer本地事务是否正常（一般是通过查询数据库中的数据是否已经持久化）</span></span></p></div><div id="https://www.notion.so/80fde9bdebf34b19ab7ff9d750ff0963" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">3.消费者消费消息</span></span></p></div><div id="https://www.notion.so/d14e0c53ea7b411bb42681497405bd98" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">4.如果有消费者消费失败，则将失败的消息传给broker，即重新写入commitLog，消费者将重新消费；如果此时consumer和broker连接断开，consumer调用submitConsumeRequestLater()方法，在consumer处重新消费，16次之后，则必须通过工单、日志等方式进行人工干预使producer事务进行回退。如果此时consumer和broker网络断开，consumer会将该消息存入失败队列，并重新消费失败队列中的消息，并且继续调用submitConsumeRequestLater()。</span></span></p></div><div id="https://www.notion.so/b4e5cb8a28ba42edad5c8b33495113ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/51c0ff49a42948e7ae52a8bbc4f8c476" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/51c0ff49a42948e7ae52a8bbc4f8c476"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">消息堆积问题</span></span></h3><div id="https://www.notion.so/689f1c867d114b9c8ccc15204806427d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">生产者生产太快：在生产者部分使用</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">限流降级</strong></span><span class="SemanticString">的方法。</span></span></p></div><div id="https://www.notion.so/062b8b779602462c9822774a0f8b1212" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">消费者消费太慢：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/edf1eeabe85c4dc9b972629a5517c968" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">增加消费者实例、增加消息队列中每个主题的队列数量。</span></span></li><li id="https://www.notion.so/7e2c40b8fa8d4b51acbc7c4b8c25efe3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">检查是否是消费者出现了大量的消费错误。</span></span></li><li id="https://www.notion.so/b5907bd93b1e474dabc6239f38833d8d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">打印一下日志看是否哪个线程卡死，出现了锁资源不释放的问题。</span></span></li></ul><div id="https://www.notion.so/990add9c833a4e8caf7dbc7ea9c6a249" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/fd4885f1ea744af0b3e8c01a9a17a8a4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/fd4885f1ea744af0b3e8c01a9a17a8a4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">刷盘策略</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/307297b3fc46499e8b8f7e573b97a344" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">同步刷盘：消息追加到内存后立即刷到硬盘中存储</span></span></li><li id="https://www.notion.so/3381b414e461432ea5be21d52b169da1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">异步刷盘：消息追加到内存中，在后台异步刷到硬盘中存储。</span></span></li></ul><div id="https://www.notion.so/90bd3df4bf644bf28fe6fb01469700a4" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5186cc80-a7e4-40fe-afe3-05b3878b1c68%2FUntitled.png?width=1101&amp;table=block&amp;id=90bd3df4-bf64-4bf2-8fe6-fb01469700a4"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5186cc80-a7e4-40fe-afe3-05b3878b1c68%2FUntitled.png?width=1101&amp;table=block&amp;id=90bd3df4-bf64-4bf2-8fe6-fb01469700a4" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/a2d9dca96ca9413080fbfe57512bda6d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如上图所示，同步刷盘小等待一个刷盘成功的ACK，同步刷盘对MQ消息可靠性是很好的保障，因此在性能上会有较大影响，一般适用于金融等特定业务场景。</span></span></p></div><div id="https://www.notion.so/25c61d10f7b04bf2919410354176d0d0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">异步刷盘则是开启一个线程异步执行刷盘操作，采用后台异步线程提交的方式进行，降低了读写延迟，提高了MQ的性能和吞吐量，适用于发验证码等对于消息保证要求不高的业务场景。只有在broker宕机的时候会丢失部分数据。</span></span></p></div><div id="https://www.notion.so/5aefefabf92a44e6adf12161875567e7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RocketMQ</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">默认采用异步刷盘策略</strong></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/5b9f7f384f894bffb964efdb9b351115" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/d2d65b4d52904892b4924e6b35bfee56" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d2d65b4d52904892b4924e6b35bfee56"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">同步复制和异步复制</span></span></h3><div id="https://www.notion.so/030cf58d47c34fff8bd9d83c0a973b0a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这里指broker中的主从同步。</span></span></p></div><div id="https://www.notion.so/d7f5d70c91a0460eae5f64064e951d45" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">同步复制：只有消息同步双写到主从节点上时才返回写入成功。</span></span></p></div><div id="https://www.notion.so/7983fd14e464418ca91991d7728cdbf4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">异步复制：消息写入主节点后即返回写入成功。</span></span></p></div><div id="https://www.notion.so/fe2408091d1349b2aaadc93aa1e2a1da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">异步复制时，当主节点挂掉，消费者会从从节点进行消费（producer不能再生产消息了），待主节点重启后，从节点会继续复制主从节点不同步的部分。</span></span></p></div><div id="https://www.notion.so/4c7e507776724fdc930f560406287fa5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">使用多主从设置（同一个topic可以分布在不同的broker中，设置多主从，一个broker的主节点挂掉，部署在其他broker的主节点依旧可用），可以保证producer的生产能够正常进行。但是这种方式又无法保证顺序（如之前的部分所述，为保证消息的顺序性，我们通常将一类语义信息发送到同一个队列，举个例子，主节点A负责订单A类，其他节点是无法代替主节点A，设置多主节点A1、A2、A3的话，订单A类的消费顺序就无法得到保证）。</span></span></p></div><div id="https://www.notion.so/bda1d44efc6f458f9bc841300f2b9add" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RocketMQ中采用的Dledger解决了这个问题：在写入消息过程中，要求消息最少复制到半数以上节点（会牺牲一些效率），才给producer返回写入成功，并且它支持通过选举切换主节点。</span></span></p></div><div id="https://www.notion.so/3ea057fb4cf647aeb33961595d7f6f27" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/d0ceb8f9a00c4508843211eb254d25ce" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d0ceb8f9a00c4508843211eb254d25ce"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">存储机制</span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/e2574d1cbe8144d9a029ea5c4505c0ed" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">CommitLog:消息主体以及元数据的存储主体，单个文件大小默认1G，文件名长度20位，左边补零，剩余为起始偏移量，比如00000000000000000000代表了第一个文件，起始偏移量为0，文件大小为1G=1073741824；当第一个文件写满了，第二个文件为00000000001073741824，起始偏移量为1073741824，以此类推。消息主要是</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">顺序写入日志文件</strong></span><span class="SemanticString">，当文件满了，写入下一个文件。</span></span></li><li id="https://www.notion.so/aa766b8a5d5044d59d94f4d6d584648b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">ConsumeQueue:消息消费队列，作为消费消息的索引，保存了指定Topic下的队列消息在CommitLog中的起始物理偏移量offset，消息大小size和消息Tag的hashcode值，可以视为基于topic的commitlog索引文件，组织结构为：topic/queue/file，存储路径为$HOME/store/consumequeue/{topic}/{queueId}/{fileName}。consumeLog采用定长设置，每个条目20字节，8字节的commitLog物理偏移量、4字节的消息长度、8字节tag的hashcode，单个文件由30w个条目组成，像数组一样可以随机访问，每个consumeQueue大小约5.72M。</span></span></li><li id="https://www.notion.so/4ade77e19e484b3494852b50eb9ea4b8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">IndexFile:提供了一种可以通过key和时间区间来查询消息的方法。</span></span></li></ul><div id="https://www.notion.so/b3a6b97cc6f24dc4aa515f56aa4f5237" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F16739078-4265-425e-9a92-3fadc4140943%2FUntitled.png?width=745&amp;table=block&amp;id=b3a6b97c-c6f2-4dc4-aa51-5f56aa4f5237"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F16739078-4265-425e-9a92-3fadc4140943%2FUntitled.png?width=745&amp;table=block&amp;id=b3a6b97c-c6f2-4dc4-aa51-5f56aa4f5237" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/a2cf2bb81d7d41888b727b114f3078ac" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RocketMQ采用了混合型存储结构，broker单个实例下所有的队列共用一个日志数据文件来存储消息。</span></span></p></div><div id="https://www.notion.so/ba69140782214cafba1bcd496c3162ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Kafka则为每个Topic分配一个存储文件。</span></span></p></div><div id="https://www.notion.so/f032f8caa42d407899d1daec89ae7e5a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">两者一个把东西赛一个大房间，另一个把东西塞到不同功能的小房间。</span></span></p></div><div id="https://www.notion.so/677ede4fe1ea4e59a542392e0dab2c81" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">显而易见，前者数据写入效率更高，但也会在读取时遍历整个房间。</span></span></p></div><div id="https://www.notion.so/975ee2501ec94927be1a78cf0f6a1513" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">然而RocketMQ引入了consumerQueue作为每个队列的索引文件夹，来提升消息的读取效率，可以根据句队列的消息序号，计算出索引的全局位置（索引序号*索引固定长度20），然后直接读取这条索引，再根据索引中记录的消息的全局位置，找到消息。</span></span></p></div><div id="https://www.notion.so/47106fdb9a2f4d1e99d14f0a68976f30" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F95fa86d9-b082-4742-a4d2-74676b8c0e3a%2FUntitled.png?width=1142&amp;table=block&amp;id=47106fdb-9a2f-4d1e-99d1-4f0a68976f30"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F95fa86d9-b082-4742-a4d2-74676b8c0e3a%2FUntitled.png?width=1142&amp;table=block&amp;id=47106fdb-9a2f-4d1e-99d1-4f0a68976f30" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/68b3556b9a7045efafae3ba4bf9acbf5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/d25dd329c0d54311a187833d09a16944" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <footer class="Footer">
  <div>&copy; NorthWind 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>