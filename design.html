<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ“–&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>è®¾è®¡æ¨¡å¼&nbsp;|&nbsp;NorthWind</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="è®¾è®¡æ¨¡å¼">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ¹&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ“–&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="learn.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ—’ï¸&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>Learning Notes</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about-me-569345.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ–ï¸&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About Me</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ¹&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">è®¾è®¡æ¨¡å¼</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, Oct 14, 2022</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/learning.html">learning</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/dd49eb3837f84d1a8a91ddf99b6c98e1" class="PageRoot"><div id="https://www.notion.so/6f4cd5f375444604a51caa20e08d0813" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è¿™å‡ å¤©é€šè¿‡åœ¨å…¬å¸çœ‹ä»£ç ï¼Œå‘ç°å¾ˆå¤šè®¾è®¡æ¨¡å¼çš„ä½¿ç”¨ï¼Œè¿™é‡Œè¿›è¡Œä¸€ä¸‹æ€»ç»“ï¼š</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/fa0df41b1b124da2a74ba3afa2adb7f4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">å•ä¾‹æ¨¡å¼</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/a85289d9c24e43b4a3a5a7441d9cdece" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">é¥¿æ±‰</span></span><pre id="https://www.notion.so/ad28b3fc294442418a438cf6c4c51ca9" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lubenwei</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Lubenwei</span> lbw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Lubenwei</span> <span class="token function">getLbw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> lbw<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre></li><li id="https://www.notion.so/8b77d25b9ec14667b795e34559f8cf48" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">æ‡’æ±‰</span></span><pre id="https://www.notion.so/3c59511ec9004c16af42fe4f5c4d829b" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lubenwei</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Lubenwei</span> lbw<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token class-name">Lubenwei</span> <span class="token function">getLbw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lbw <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            lbw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> lbw<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre></li><li id="https://www.notion.so/b3dba6c760e64b37b37932e219405c1b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">åŒé‡æ£€æµ‹</span></span><pre id="https://www.notion.so/acec21a21a534ee0b01d0ac62593d55c" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lubenwei</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Lubenwei</span> lubenwei<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Lubenwei</span> <span class="token function">getLubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lubenwei <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Lubenwei</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lubenwei <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    lubenwei <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> lubenwei<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre></li><li id="https://www.notion.so/b75288070aa1479e8c344492aced7583" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">æšä¸¾ï¼ˆè¯·ä½¿ç”¨è¿™ä¸ªï¼‰</strong></span></span><div id="https://www.notion.so/d457d0c996184e25b09e5ca05afb064d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è¯´æ˜ä¸€ä¸‹ï¼Œé¡¹ç›®é‡Œç”¨åˆ°çš„å•ä¾‹ï¼Œå…¨éƒ¨éƒ½æ˜¯è¿™ç§æ¨¡å¼ï¼Œä¸ä»…èƒ½é¿å…å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œè¿˜è‡ªåŠ¨æ”¯æŒåºåˆ—åŒ–æœºåˆ¶ã€‚</span></span></p></div><pre id="https://www.notion.so/8e9e9b7ec31a4dd0ae8a7d7f3a3870c9" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Lubenwei</span> <span class="token punctuation">{</span>
    lubenwei<span class="token punctuation">;</span>
    <span class="token comment">//è¯¥å¯¹è±¡å…¨å±€å”¯ä¸€</span>
<span class="token punctuation">}</span></span></span></span></code></pre></li></ul><div id="https://www.notion.so/3ca7f225509e418284f3f7215827086a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></li></ul><div id="https://www.notion.so/5009155cb7e1494992cce3b1095e1d73" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹</span></span></p></div><div id="https://www.notion.so/5d087f1c7907455c9d4974a5a731f02c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">é€šè¿‡è¿™å‡ å¤©çš„è§‚å¯Ÿï¼Œè¿™ä¸ªä¸»è¦ç”¨äºå¼‚æ­¥æ¶ˆæ¯å†™å…¥æˆ–è€…æœåŠ¡é—´è§£è€¦ï¼Œä¸»è¦æ˜¯å¼‚æ­¥ã€‚</span></span></p></div><pre id="https://www.notion.so/dbd34b2e60ae418c9e3ff21a10b3313b" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>operator<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>file</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Operator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>decriptor<span class="token punctuation">.</span></span><span class="token class-name">AttrDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>decriptor<span class="token punctuation">.</span></span><span class="token class-name">InputDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>decriptor<span class="token punctuation">.</span></span><span class="token class-name">MetaDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>decriptor<span class="token punctuation">.</span></span><span class="token class-name">OutputDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span><span class="token class-name">Env</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>operator<span class="token punctuation">.</span>define<span class="token punctuation">.</span>writer<span class="token punctuation">.</span></span><span class="token class-name">AbstractWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">NamedThreadFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">DataType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>operator<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">OperatorConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>record<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">FixedFieldDict</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>record<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span><span class="token class-name">AbstractNativeMsg</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">Joiner</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span></span><span class="token class-name">Lists</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>util<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>shaded<span class="token punctuation">.</span>org<span class="token punctuation">.</span>jctools<span class="token punctuation">.</span>queues<span class="token punctuation">.</span></span><span class="token class-name">MpscArrayQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>prometheus<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Gauge</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">MultiKey</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">MultiKeyMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">StringEscapeUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Closeable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Paths</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicBoolean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicLong</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>prometheus<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Counter</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * FIXME TJå®šåˆ¶çš„è¾“å‡ºç®—å­ï¼Œä¸´æ—¶è§£å†³åŠæ³•
 *
 * @author XFS
 * @version 1.0
 * @date 2022/10/10/ 21:50
 * @since 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Operator</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TjFileWriter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractWriter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractNativeMsg</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DESCRIPTION</span> <span class="token operator">=</span> <span class="token string">"[TJå®šåˆ¶ - å†™MainFileç‰ˆæœ¬] æ—¥å¿—æŒ‰è¦æ±‚è¾“å‡ºåˆ°æœ¬åœ°æ–‡ä»¶ä¸­"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_SUB_FILE_INTERVAL</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEPLOY_CITY_CODE</span> <span class="token operator">=</span> <span class="token string">"deploy.city.code"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PROMETHEUS_MONITOR_ENABLE</span> <span class="token operator">=</span> <span class="token string">"prometheus.monitor.enable"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> <span class="token constant">INIT_ONCE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> <span class="token constant">TOTAL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_WORK_DIR</span> <span class="token operator">=</span> <span class="token string">"file_log"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_FILE_PREFIX</span> <span class="token operator">=</span> <span class="token string">"debug"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MSG_TYPE_JSON</span> <span class="token operator">=</span> <span class="token string">"json"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MSG_TYPE_FORMATTED_STRING</span> <span class="token operator">=</span> <span class="token string">"formatted_string"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SELECTED_FIELDS</span> <span class="token operator">=</span> <span class="token string">"selectedFields"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_MSG_TYPE</span> <span class="token operator">=</span> <span class="token string">"msgType"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_WORK_DIR</span> <span class="token operator">=</span> <span class="token string">"workDir"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SUB_FILE_TYPE</span> <span class="token operator">=</span> <span class="token string">"subFileType"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_FILE_PREFIX</span> <span class="token operator">=</span> <span class="token string">"filePrefix"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">"fileSuffix"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SEPARATOR_NAME</span> <span class="token operator">=</span> <span class="token string">"separator"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SUB_FILE_INTERVAL</span> <span class="token operator">=</span> <span class="token string">"subFileInterval"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_RAWS_LIMIT_PER_FILE</span> <span class="token operator">=</span> <span class="token string">"rows.limit.per.file"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * å…¨å±€é…ç½®
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SYNC</span> <span class="token operator">=</span> <span class="token string">"sync"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_THREAD_NUM</span> <span class="token operator">=</span> <span class="token string">"threadNum"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_BLOCK</span> <span class="token operator">=</span> <span class="token string">"block"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SELECTED_FIELDS</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">MSG_TYPE</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">WORK_DIR</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">FILE_PREFIX</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">FILE_SUFFIX</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SUB_FILE_TYPE</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SYNC</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">THREAD_NUM</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">BLOCK</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SEPARATOR</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SUB_FILE_INTERVAL</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">ROWS_LIMIT_PER_FILE</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrDescriptor</span><span class="token punctuation">></span></span> <span class="token constant">ATTR_DESCRIPTORS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç›‘æ§æŒ‡æ ‡
     */</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_NAMESPACE</span> <span class="token operator">=</span> <span class="token string">"flowpipe"</span><span class="token punctuation">;</span>


    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token constant">SELECTED_FIELDS</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SELECTED_FIELDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">ARRAY</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"é€‰æ‹©è¾“å‡ºçš„å­—æ®µåˆ—è¡¨,é»˜è®¤è¾“å‡ºå…¨éƒ¨"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">MSG_TYPE</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_MSG_TYPE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">ENUM</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"è¾“å‡ºæ¶ˆæ¯æ ¼å¼ï¼Œå½“å‰æ”¯æŒjsonå’Œformatted_string"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">modifiable</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">MSG_TYPE_JSON</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token constant">MSG_TYPE_JSON</span><span class="token punctuation">,</span> <span class="token constant">MSG_TYPE_FORMATTED_STRING</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SEPARATOR</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SEPARATOR_NAME</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"åˆ†éš”ç¬¦ï¼Œé»˜è®¤ |, æ¶ˆæ¯è¾“å‡ºæ ¼å¼ä¸ºformatted_stringæ—¶æœ‰æ•ˆ"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">FILE_PREFIX</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_FILE_PREFIX</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶åå‰ç¼€"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_FILE_PREFIX</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_FILE_SUFFIX</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶ååç¼€"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_FILE_SUFFIX</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SUB_FILE_TYPE</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SUB_FILE_TYPE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">ENUM</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶åˆ‡åˆ†ç±»å‹ï¼Œé»˜è®¤ä¸åˆ‡åˆ†æ–‡ä»¶"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_DAY</span><span class="token punctuation">,</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_HOUR</span><span class="token punctuation">,</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_MINUTE</span><span class="token punctuation">,</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_SECOND</span><span class="token punctuation">,</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_NONE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_NONE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SUB_FILE_INTERVAL</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SUB_FILE_INTERVAL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶åˆ‡åˆ†é—´éš”ï¼Œé»˜è®¤ä¸º1ï¼Œä¸åˆ‡åˆ†ç±»å‹é…åˆä½¿ç”¨"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_SUB_FILE_INTERVAL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">WORK_DIR</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_WORK_DIR</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶è¾“å‡ºç›®å½•"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_WORK_DIR</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ROWS_LIMIT_PER_FILE</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_RAWS_LIMIT_PER_FILE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"å•ä¸ªæ–‡ä»¶çš„æ¡æ•°é™åˆ¶"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token constant">SYNC</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SYNC</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">BOOL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"æ˜¯å¦åŒæ­¥å†™å…¥æ–¹å¼ï¼Œé»˜è®¤ä¸ºtrue"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">modifiable</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">THREAD_NUM</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_THREAD_NUM</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"å¼‚æ­¥å†™æ–‡ä»¶çº¿ç¨‹æ•°"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">BLOCK</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_BLOCK</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">BOOL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"å†™å…¥æ˜¯å¦é˜»å¡"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">modifiable</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SELECTED_FIELDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">MSG_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">FILE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SUB_FILE_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SUB_FILE_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">WORK_DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">ROWS_LIMIT_PER_FILE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SYNC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">THREAD_NUM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">BLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">DESCRIPTION</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">InputDescriptor</span> <span class="token function">inputDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">BASE_INPUT</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OutputDescriptor</span> <span class="token function">outputDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">BASE_OUTPUT</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MetaDescriptor</span> <span class="token function">metaDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_META</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrDescriptor</span><span class="token punctuation">></span></span> <span class="token function">attrDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">FILE_CLOSE_WORKER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token number">1L</span><span class="token punctuation">,</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"file-close-worker"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * å±€éƒ¨å±æ€§
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> selectedFields<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> filePrefix<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> fileSuffix<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msgType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> subFileType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> workDir<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> shutdown<span class="token punctuation">;</span>

    <span class="token comment">/**
     * å…¨å±€å±æ€§
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Boolean</span> attrSync<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Boolean</span> attrBlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> threadNum<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WriteWorker</span><span class="token punctuation">></span></span> writeWorks<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">WriteWorker</span> syncWriteWorker<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MpscArrayQueue</span><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span><span class="token punctuation">></span></span> queues<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executor<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> separator<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> subFileInterval<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> rowsPerFile<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> deployCityCode<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterBCPCreate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterBCPClose<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterMainFileCreate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterMainFileClose<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterBCPBytes<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterMainFileBytes<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Counter</span><span class="token punctuation">></span></span> <span class="token constant">COUNTER_ROSTER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">init0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        selectedFields <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getStringList</span><span class="token punctuation">(</span><span class="token constant">ATTR_SELECTED_FIELDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filePrefix <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_FILE_PREFIX</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_FILE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileSuffix <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_FILE_SUFFIX</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msgType <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_MSG_TYPE</span><span class="token punctuation">,</span> <span class="token constant">MSG_TYPE_JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subFileType <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_SUB_FILE_TYPE</span><span class="token punctuation">,</span> <span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ ¡éªŒå½“å‰ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿›è¡Œåˆ›å»º</span>
        workDir <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_WORK_DIR</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_WORK_DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token constant">ATTR_MSG_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">MSG_TYPE_FORMATTED_STRING</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            separator <span class="token operator">=</span> <span class="token class-name">StringEscapeUtils</span><span class="token punctuation">.</span><span class="token function">unescapeJava</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token constant">ATTR_SEPARATOR_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"separatorå‚æ•°ç¼ºå¤±"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">checkForCreateDir</span><span class="token punctuation">(</span>workDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        subFileInterval <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getIntOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_SUB_FILE_INTERVAL</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_SUB_FILE_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rowsPerFile <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getIntOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_RAWS_LIMIT_PER_FILE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//bcpcount</span>
        <span class="token class-name">String</span> counterKeyBCPCreate <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span> filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyBCPClose <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span> filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyMainFileCreate <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span> filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyMainFileClose <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span> filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyBCP <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span>filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyMainFile <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span>filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        counterBCPCreate <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyBCPCreate<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
           <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_create"</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyBCPCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterBCPClose <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyBCPClose<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
           <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_close"</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyBCPClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterMainFileCreate <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyMainFileCreate<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_create"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyMainFileCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterMainFileClose <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyMainFileClose<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_close"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyMainFileClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterBCPBytes <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyBCP<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span>  <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_bytes"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyBCP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterMainFileBytes <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyMainFile<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_bytes"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyMainFile<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">labelNames</span><span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">)</span>    <span class="token punctuation">;</span>
            <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">initOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * æ‰§è¡Œåªåˆå§‹åŒ–ä¸€æ¬¡çš„ä»»åŠ¡
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">initOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">INIT_ONCE</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//éåŒæ­¥çš„æ–¹å¼éœ€è¦åˆ›å»ºçº¿ç¨‹æ¥è¿›è¡Œæ•°æ®å†™å…¥</span>
            attrSync <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token constant">ATTR_SYNC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>attrSync<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                threadNum <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token constant">ATTR_THREAD_NUM</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                attrBlock <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token constant">ATTR_BLOCK</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ ¹æ®threadNum åˆå§‹åŒ–çº¿ç¨‹</span>
                executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>threadNum<span class="token punctuation">,</span> threadNum<span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"file-write-worker"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                queues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                writeWorks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">10240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    queues<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">WriteWorker</span> writeWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteWorker</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writeWorks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>writeWorker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>writeWorker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                syncWriteWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getGaugeKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">AbstractNativeMsg</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">FileWriterItem</span> writerItem <span class="token operator">=</span> <span class="token function">genWriteItem</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attrSync<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">writeSync</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">writeAsync</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeSync</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä½¿ç”¨å½“å‰çº¿ç¨‹å†™å…¥</span>
        syncWriteWorker<span class="token punctuation">.</span><span class="token function">tryWrite2File</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeAsync</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sleep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> <span class="token constant">TOTAL</span><span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>total <span class="token operator">%</span> threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> queues<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸´æ—¶æ‰“å° == > ä¿®æ”¹æ—¶é—´è‡ªé€‚åº”æ‰“å°ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>total <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">100_000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===>>> FileWriteræ¶ˆè´¹é˜Ÿåˆ—ä¸­å…ƒç´ ä¸ªæ•°ä¸ºï¼š{}"</span><span class="token punctuation">,</span> <span class="token class-name">Joiner</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>queues<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Queue</span><span class="token operator">::</span><span class="token function">size</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// block ä¸ºtrue ä»£è¡¨ä¸èƒ½ä¸¢æ¶ˆæ¯ï¼Œéœ€è¦é˜»å¡ç­‰å¾…é˜Ÿåˆ—æœ‰å®¹é‡èƒ½å¤Ÿæ”¾å…¥å½“å‰æ¶ˆæ¯</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attrBlock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token operator">++</span>sleep<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">exceptionHandle</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exceptionHandle</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡åˆ°ä¸­æ–­å¼‚å¸¸ï¼Œéœ€è¦å…³é—­å½“å‰å†™çº¿ç¨‹</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token class-name">FileWriterItem</span> <span class="token function">genWriteItem</span><span class="token punctuation">(</span><span class="token class-name">AbstractNativeMsg</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">FileWriterItem</span> writerItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriterItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä½†æ˜¯ä½¿ç”¨çš„æ˜¯ä¸€ä»½å±€éƒ¨æ‹·è´çš„æ–°å¯¹è±¡</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">partialClone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setFilePrefix</span><span class="token punctuation">(</span>filePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setFileSuffix</span><span class="token punctuation">(</span>fileSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setSubFileType</span><span class="token punctuation">(</span>subFileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setWorkDir</span><span class="token punctuation">(</span>workDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setSelectedFields</span><span class="token punctuation">(</span>selectedFields<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setMsgType</span><span class="token punctuation">(</span>msgType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setSep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setSubFileInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subFileInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setRowsPerFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rowsPerFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//monitor</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterBCPCreate</span><span class="token punctuation">(</span>counterBCPCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterBCPClose</span><span class="token punctuation">(</span>counterBCPClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterMainFileCreate</span><span class="token punctuation">(</span>counterMainFileCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterMainFileClose</span><span class="token punctuation">(</span>counterMainFileClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterBCPBytes</span><span class="token punctuation">(</span>counterBCPBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterMainFileBytes</span><span class="token punctuation">(</span>counterMainFileBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> writerItem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * æ£€æŸ¥æˆ–åˆ›å»ºæ–‡ä»¶å¤¹
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">checkForCreateDir</span><span class="token punctuation">(</span><span class="token class-name">String</span> dirName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dirName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            file<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shutdown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writeWorks <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>writeWorks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            writeWorks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">WriteWorker</span><span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//******************************************************************************************************************//</span>
    <span class="token comment">//********************************************   WRITE  THREAD  START   ********************************************//</span>
    <span class="token comment">//******************************************************************************************************************//</span>

    <span class="token comment">/**
     * debug æ—¥å¿—å†™çº¿ç¨‹
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteWorker</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WORKER_STATUS_NEW</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WORKER_STATUS_RUNNING</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WORKER_STATUS_EXIT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WAITING_MAX_TIMES</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW_FILE_FILED</span> <span class="token operator">=</span> <span class="token string">"_RAW_FILE_FIELD"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW_FILE_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW_FILE_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW1_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW1_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW2_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW2_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW1_BASE64_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW1_BASE64_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW2_BASE64_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW2_BASE64_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TWO_LINE_SEP</span> <span class="token operator">=</span> <span class="token string">"\n\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FILE_NAME_SEPARATOR</span> <span class="token operator">=</span> <span class="token string">"-"</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringBuilder</span><span class="token punctuation">></span></span> <span class="token constant">STRING_BUILDER_THREAD_LOCAL</span> <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">AtomicBoolean</span> shutdown <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span></span> queue<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> fileCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MultiKeyMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WriterWrapper</span><span class="token punctuation">></span></span> writerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiKeyMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> mainFileCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> deployCityCode<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Boolean</span> prometheusEnable <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token class-name">Env</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token constant">PROMETHEUS_MONITOR_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">public</span> <span class="token class-name">WriteWorker</span><span class="token punctuation">(</span><span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span></span> queue<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">WORKER_STATUS_NEW</span><span class="token punctuation">;</span>
            <span class="token comment">// è·å–ä¸æˆéƒ¨ç½²çš„åœ°å¸‚åŒºåŸŸç¼–ç </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>deployCityCode <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token class-name">Env</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token constant">DEPLOY_CITY_CODE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">"null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> sleep <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            status <span class="token operator">=</span> <span class="token constant">WORKER_STATUS_RUNNING</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>shutdown<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">boolean</span> success <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">tryWrite2File</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success <span class="token operator">&amp;&amp;</span> queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>sleep<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        sleep <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"write thread error: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// todo å¼‚å¸¸å¤„ç†ï¼ŒæŒ‚æ‰å½“å‰çº¿ç¨‹ã€‚</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            status <span class="token operator">=</span> <span class="token constant">WORKER_STATUS_EXIT</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"FileWrite Thread exit, stop:{}, interrupted:{}"</span><span class="token punctuation">,</span> shutdown<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœ queue ä¸­è¿˜æœ‰æ•°æ®ï¼Œå°è¯•å°†å‰©ä½™çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}å¼€å§‹æ‰§è¡Œå…³é—­é€»è¾‘"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"file-write-worker-[{}]ç¼“å­˜é˜Ÿåˆ—éç©ºï¼Œå‰©ä½™æ—¥å¿—æ•°ï¼š[{}], å°è¯•å°†é˜Ÿåˆ—ä¸­æ•°æ®å†™å…¥æ–‡ä»¶"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    queue<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">tryWrite2File</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">MultiKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">WriterWrapper</span><span class="token punctuation">></span><span class="token punctuation">></span></span> iterator <span class="token operator">=</span> writerMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MultiKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">WriterWrapper</span><span class="token punctuation">></span></span> next <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">WriterWrapper</span> wrapper <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å…³é—­æ—¶ä½¿ç”¨åŒæ­¥æ–¹å¼è¿›è¡Œå…³é—­</span>
                        wrapper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterBCPClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterBCPBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// å…³é—­åå°†å…ƒç´ ç§»é™¤</span>
                        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"è¿›ç¨‹å…³é—­ï¼Œå…³é—­æ–‡ä»¶[{}]å‡ºç°å¼‚å¸¸ï¼š"</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}å…³é—­å¼‚å¸¸ï¼š"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shutdown<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> times <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ç­‰å¾…worker çº¿ç¨‹æ­£å¸¸é€€å‡ºæˆ–è€…è¾¾åˆ°æœ€å¤§ç­‰å¾…æ—¶é•¿</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token constant">WORKER_STATUS_EXIT</span> <span class="token operator">||</span> times <span class="token operator">>=</span> <span class="token constant">WAITING_MAX_TIMES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        times<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"file-write-worker-{}å…³é—­å¼‚å¸¸ï¼š"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token comment">/**
         * æ‰§è¡Œå†™æ–‡ä»¶é€»è¾‘
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">tryWrite2File</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODO å¾…ä¼˜åŒ– å½“å‰ä¾é æ–°çš„æ—¥å¿—æ¥è§¦å‘æ–‡ä»¶åˆ‡æ¢çš„æ¡ä»¶</span>
            <span class="token class-name">WriterWrapper</span> wrapper <span class="token operator">=</span> <span class="token function">getWriterOrCreate</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœè¢«é‡ç½®äº†ï¼Œéœ€è¦å†æ¬¡è·å–wrapper</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">resetWriterIfNeed</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    wrapper <span class="token operator">=</span> <span class="token function">getWriterOrCreate</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å¤„ç†åŸå§‹ç æµæ–‡ä»¶</span>
                    <span class="token function">dealWithRawFile</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// å†™å…¥bcpæ–‡ä»¶</span>
                    <span class="token class-name">String</span> writeMsg <span class="token operator">=</span> <span class="token function">genWriteMsg</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>writeMsg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        wrapper<span class="token punctuation">.</span><span class="token function">writeRow</span><span class="token punctuation">(</span>writeMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// æš‚æ—¶ä¸éœ€è¦é‡ç½® MAINFILE å­—æ®µï¼Œå½“å‰msgå¯¹è±¡æ˜¯ä¸€ä»½æ‹·è´ï¼Œæ–°å¢å­—æ®µä¸ä¼šå½±å“åŸå¯¹è±¡</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"å†™å…¥å†…å®¹å¼‚å¸¸, fileName:[{}], error"</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * ç”Ÿæˆmainfile
         *
         * @param writerItem
         * @param wrapper
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dealWithRawFile</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">,</span> <span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AbstractNativeMsg</span> msg <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> rawFileEnable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW_FILE_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rawFileEnable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>rawFileEnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Boolean</span> raw1Enable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW1_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> raw2Enable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW2_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> raw1Base64Enable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW1_BASE64_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> raw2Base64Enable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW2_BASE64_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è‡³å°‘éœ€è¦å¼€å¯ä¸€ä¸ªé€‰é¡¹æ‰è¿›è¡Œå†™å…¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>raw1Enable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>raw1Enable<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>raw2Enable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>raw2Enable<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>raw1Base64Enable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>raw1Base64Enable<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>raw2Base64Enable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>raw2Base64Enable<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//æ‰“ç‚¹è®°ä¸€æ¬¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">FixedFieldDict</span><span class="token punctuation">.</span><span class="token constant">RAW_1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">FixedFieldDict</span><span class="token punctuation">.</span><span class="token constant">RAW_2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> rawFileField <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW_FILE_FILED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åŸå§‹ç æµéƒ½ä¸å­˜åœ¨çš„æƒ…å†µä¸‹ä¹Ÿä¸éœ€è¦å†™mainfile</span>
            <span class="token comment">// å¦‚æœå·²ç»å¡«äº†mainfile,åˆ™éœ€è¦å¤„ç†(å¤åˆ¶æ–‡ä»¶åˆ°æ­£ç¡®çš„åœ°æ–¹)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">rawDataEnable</span><span class="token punctuation">(</span>raw1<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">rawDataEnable</span><span class="token punctuation">(</span>raw2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">try2HandleMainFile</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">,</span> wrapper<span class="token punctuation">,</span> raw1Enable<span class="token punctuation">,</span> raw2Enable<span class="token punctuation">,</span> raw1Base64Enable<span class="token punctuation">,</span> raw2Base64Enable<span class="token punctuation">,</span> raw1<span class="token punctuation">,</span> raw2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">try2HandleMainFile</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">,</span>
                                        <span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">,</span>
                                        <span class="token class-name">Boolean</span> raw1Enable<span class="token punctuation">,</span>
                                        <span class="token class-name">Boolean</span> raw2Enable<span class="token punctuation">,</span>
                                        <span class="token class-name">Boolean</span> raw1Base64Enable<span class="token punctuation">,</span>
                                        <span class="token class-name">Boolean</span> raw2Base64Enable<span class="token punctuation">,</span>
                                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw1<span class="token punctuation">,</span>
                                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å½“å‰ mainfile è·Ÿ bcp  æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œå»é™¤.bcpåç¼€çš„æ–‡ä»¶åä½œä¸ºrawFileçš„ç›®å½•</span>
            <span class="token class-name">String</span> filePath <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> indexOf <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> mainFilePath <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> indexOf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> mainFileDir <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mainFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mainFileDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mainFileDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> mainFileName <span class="token operator">=</span> <span class="token function">genMainFileName</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> mainFile <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mainFileDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mainFileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> rawFileField <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW_FILE_FILED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rawFileField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> existMainFilePath <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>existMainFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>existMainFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">String</span> existMainFileName <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">String</span> existMainFileSuffix <span class="token operator">=</span> existMainFileName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> existMainFileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>existMainFileName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
                            <span class="token class-name">String</span> targetMainFileName <span class="token operator">=</span> mainFileName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> mainFileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> mainFileName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> mainFileName<span class="token punctuation">;</span>
                            mainFile <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mainFileDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetMainFileName <span class="token operator">+</span> existMainFileSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">FileUtil</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> mainFile<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//mainfileå¤åˆ¶äº†ä¸€æ¬¡ï¼Œæ‰“ç‚¹</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                                wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">labels</span><span class="token punctuation">(</span><span class="token string">"COPY"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span>mainFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mainFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">,</span> mainFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"rawFileField:{} has content:{} but no file exist"</span><span class="token punctuation">,</span> rawFileField<span class="token punctuation">,</span> existMainFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileWriter</span> mainFileWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>mainFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">//åŠ äº†ä¸€ä¸ªcounter</span>
                            <span class="token function">writeMainFileContent</span><span class="token punctuation">(</span>mainFileWriter<span class="token punctuation">,</span> raw1Enable<span class="token punctuation">,</span> raw2Enable<span class="token punctuation">,</span> raw1Base64Enable<span class="token punctuation">,</span> raw2Base64Enable<span class="token punctuation">,</span> raw1<span class="token punctuation">,</span> raw2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            mainFileWriter<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">//mainfileå†™äº†ä¸€ä¸ªï¼Œæ‰“ç‚¹</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">labels</span><span class="token punctuation">(</span><span class="token string">"WRITE"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span>mainFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// è¿›è¡Œ åŸå§‹ç æµæ–‡ä»¶å­—æ®µ èµ‹å€¼</span>
                    writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">,</span> mainFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"å†™MAINFILEå¼‚å¸¸ï¼ŒfilePrefix:[{}], å¼‚å¸¸ï¼š"</span><span class="token punctuation">,</span> writerItem<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeMainFileContent</span><span class="token punctuation">(</span><span class="token class-name">FileWriter</span> fileWriter<span class="token punctuation">,</span>
                                          <span class="token class-name">Boolean</span> raw1Enable<span class="token punctuation">,</span>
                                          <span class="token class-name">Boolean</span> raw2Enable<span class="token punctuation">,</span>
                                          <span class="token class-name">Boolean</span> raw1Base64Enable<span class="token punctuation">,</span>
                                          <span class="token class-name">Boolean</span> raw2Base64Enable<span class="token punctuation">,</span>
                                          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw1<span class="token punctuation">,</span>
                                          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rawDataEnable</span><span class="token punctuation">(</span>raw1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>raw1Enable <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw1Enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>raw1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">TWO_LINE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>raw1Base64Enable <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw1Base64Enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> raw1Base64 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>raw1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>raw1Base64<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">TWO_LINE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rawDataEnable</span><span class="token punctuation">(</span>raw2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>raw2Enable <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw2Enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>raw2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">TWO_LINE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>raw2Base64Enable <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw2Base64Enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> raw2Base64 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>raw2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>raw2Base64<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">TWO_LINE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">rawDataEnable</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> raw <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">genMainFileName</span><span class="token punctuation">(</span><span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"_raw_"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mainFileCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">".txt"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token class-name">WriterWrapper</span> <span class="token function">getWriterOrCreate</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ ¹æ®å‰ç¼€å’Œåç¼€è·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ–°å»º</span>
            <span class="token class-name">WriterWrapper</span> wrapper <span class="token operator">=</span> writerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> writerItem<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//wrapper = WriterWrapper.from(writerItem, index, fileCount.getAndIncrement(), true);</span>
                    <span class="token class-name">String</span> fileNameForTJ <span class="token operator">=</span> <span class="token function">genFileNameForTJ</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    wrapper <span class="token operator">=</span> <span class="token class-name">WriterWrapper</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">,</span> fileNameForTJ<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//æ–°å»ºäº†bcpæ–‡ä»¶ï¼Œæ‰“ç‚¹</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        writerItem<span class="token punctuation">.</span><span class="token function">getCounterBCPCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        writerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> writerItem<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"è·å–writerWrapperå¼‚å¸¸ï¼Œdata:[{}], error:"</span><span class="token punctuation">,</span> writerItem<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> wrapper<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">resetWriterIfNeed</span><span class="token punctuation">(</span><span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">isExpire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// rest the cached map</span>
                writerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">tryFlush</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">tryFlush</span><span class="token punctuation">(</span><span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wrapper<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">FILE_CLOSE_WORKER</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        wrapper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//åŒæ­¥æ¶ˆæ¯</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterBCPClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterBCPBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"try flush file close writer error: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">genWriteMsg</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msgType <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsgType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msgType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">MSG_TYPE_JSON</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">jsonTypeMsg</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token constant">MSG_TYPE_FORMATTED_STRING</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">formattedTypeMsg</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">formattedTypeMsg</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> selectedFields <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getSelectedFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedFields<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token class-name">AbstractNativeMsg</span> msg <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token constant">STRING_BUILDER_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringBuilder<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> selectedFields<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> name <span class="token operator">=</span> selectedFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Object</span> value <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token function">replaceSensitiveChars</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getSep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span> finalValue <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>selectedFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>selectedFields<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token function">replaceSensitiveChars</span><span class="token punctuation">(</span>finalValue<span class="token punctuation">,</span> writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">replaceSensitiveChars</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> part <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            if (part.contains(writerItem.getSep())) {</span>
<span class="token comment">//                part = part.replaceAll(writerItem.getSep(), URLUtil.encode(writerItem.getSep()));</span>
<span class="token comment">//            }</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                part <span class="token operator">=</span> part<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">,</span> <span class="token string">"\\\\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"\r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                part <span class="token operator">=</span> part<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\r"</span><span class="token punctuation">,</span> <span class="token string">"\\\\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                part <span class="token operator">=</span> part<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"\\\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> part<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">jsonTypeMsg</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> selectedFields <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getSelectedFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AbstractNativeMsg</span> msg <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JSONObject</span> logItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>selectedFields<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> selectedField <span class="token operator">:</span> selectedFields<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logItem<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>selectedField<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>selectedField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> logItem<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">/**
         * æ ¹æ®TJçš„è§„èŒƒç”ŸæˆfileName
         * ç”Ÿæˆè§„åˆ™ï¼š
         * &lt;pre>
         *     ç¬¬ä¸€ä¸ªå›ºå®š111ï¼Œç¬¬äºŒä¸ªæ˜¯åœ°å¸‚åŒºåŸŸç¼–ç ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ç”Ÿæˆæ—¶é—´æˆ³ï¼Œç¬¬å››ä¸ªæ˜¯éšæœºæ•°ï¼Œç¬¬äº”ä¸ªæ˜¯å¤§å†™ç±»å‹åï¼Œç¬¬å…­ä¸ª0.xx1_bqä¿ç•™ä¸åŠ¨
         *     ç¤ºä¾‹ï¼š111-511100-1620575830-06580-DATA_IM-0.xx1_bq.bcp
         * &lt;/pre>
         *
         * @return
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">genFileNameForTJ</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>deployCityCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>fileCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"xx1_bq"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//******************************************************************************************************************//</span>
    <span class="token comment">//********************************************   WRITE  THREAD   END    ********************************************//</span>
    <span class="token comment">//******************************************************************************************************************//</span>


<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/c7d949f743bc47019ba33d161d18b6da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è¿™é‡Œé¢ç”Ÿæˆäº†ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œç”¨éé˜»å¡ã€å¼‚æ­¥çš„æ–¹å¼å¤„ç†IOã€‚</span></span></p></div></article>
  <footer class="Footer">
  <div>&copy; NorthWind 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>