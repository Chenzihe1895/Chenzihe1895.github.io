<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>设计模式&nbsp;|&nbsp;NorthWind</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="设计模式">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🏹&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="learn.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🗒️&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>Learning Notes</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about-me-569345.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🎖️&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About Me</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🏹&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">设计模式</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, Oct 14, 2022</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/learning.html">learning</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/dd49eb3837f84d1a8a91ddf99b6c98e1" class="PageRoot"><div id="https://www.notion.so/6f4cd5f375444604a51caa20e08d0813" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这几天通过在公司看代码，发现很多设计模式的使用，这里进行一下总结：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/fa0df41b1b124da2a74ba3afa2adb7f4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">单例模式</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/a85289d9c24e43b4a3a5a7441d9cdece" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">饿汉</span></span><pre id="https://www.notion.so/ad28b3fc294442418a438cf6c4c51ca9" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lubenwei</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Lubenwei</span> lbw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Lubenwei</span> <span class="token function">getLbw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> lbw<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre></li><li id="https://www.notion.so/8b77d25b9ec14667b795e34559f8cf48" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">懒汉</span></span><pre id="https://www.notion.so/3c59511ec9004c16af42fe4f5c4d829b" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lubenwei</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Lubenwei</span> lbw<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token class-name">Lubenwei</span> <span class="token function">getLbw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lbw <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            lbw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> lbw<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre></li><li id="https://www.notion.so/b3dba6c760e64b37b37932e219405c1b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">双重检测</span></span><pre id="https://www.notion.so/acec21a21a534ee0b01d0ac62593d55c" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lubenwei</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Lubenwei</span> lubenwei<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Lubenwei</span> <span class="token function">getLubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lubenwei <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Lubenwei</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lubenwei <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    lubenwei <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lubenwei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> lubenwei<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre></li><li id="https://www.notion.so/b75288070aa1479e8c344492aced7583" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">枚举（请使用这个）</strong></span></span><div id="https://www.notion.so/d457d0c996184e25b09e5ca05afb064d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">说明一下，项目里用到的单例，全部都是这种模式，不仅能避免多线程同步问题，还自动支持序列化机制。</span></span></p></div><pre id="https://www.notion.so/8e9e9b7ec31a4dd0ae8a7d7f3a3870c9" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Lubenwei</span> <span class="token punctuation">{</span>
    lubenwei<span class="token punctuation">;</span>
    <span class="token comment">//该对象全局唯一</span>
<span class="token punctuation">}</span></span></span></span></code></pre></li></ul><div id="https://www.notion.so/3ca7f225509e418284f3f7215827086a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></li></ul><div id="https://www.notion.so/5009155cb7e1494992cce3b1095e1d73" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">生产者-消费者模型</span></span></p></div><div id="https://www.notion.so/5d087f1c7907455c9d4974a5a731f02c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">通过这几天的观察，这个主要用于异步消息写入或者服务间解耦，主要是异步。</span></span></p></div><pre id="https://www.notion.so/dbd34b2e60ae418c9e3ff21a10b3313b" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>operator<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>file</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Operator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>decriptor<span class="token punctuation">.</span></span><span class="token class-name">AttrDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>decriptor<span class="token punctuation">.</span></span><span class="token class-name">InputDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>decriptor<span class="token punctuation">.</span></span><span class="token class-name">MetaDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>decriptor<span class="token punctuation">.</span></span><span class="token class-name">OutputDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span><span class="token class-name">Env</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>operator<span class="token punctuation">.</span>define<span class="token punctuation">.</span>writer<span class="token punctuation">.</span></span><span class="token class-name">AbstractWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>api<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">NamedThreadFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">DataType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>operator<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">OperatorConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>record<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">FixedFieldDict</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>flowpp<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>record<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span><span class="token class-name">AbstractNativeMsg</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">Joiner</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span></span><span class="token class-name">Lists</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>util<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>shaded<span class="token punctuation">.</span>org<span class="token punctuation">.</span>jctools<span class="token punctuation">.</span>queues<span class="token punctuation">.</span></span><span class="token class-name">MpscArrayQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>prometheus<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Gauge</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">MultiKey</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">MultiKeyMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">StringEscapeUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Closeable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Paths</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicBoolean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicLong</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>prometheus<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Counter</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * FIXME TJ定制的输出算子，临时解决办法
 *
 * @author XFS
 * @version 1.0
 * @date 2022/10/10/ 21:50
 * @since 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Operator</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TjFileWriter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractWriter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractNativeMsg</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DESCRIPTION</span> <span class="token operator">=</span> <span class="token string">"[TJ定制 - 写MainFile版本] 日志按要求输出到本地文件中"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_SUB_FILE_INTERVAL</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEPLOY_CITY_CODE</span> <span class="token operator">=</span> <span class="token string">"deploy.city.code"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PROMETHEUS_MONITOR_ENABLE</span> <span class="token operator">=</span> <span class="token string">"prometheus.monitor.enable"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> <span class="token constant">INIT_ONCE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> <span class="token constant">TOTAL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_WORK_DIR</span> <span class="token operator">=</span> <span class="token string">"file_log"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_FILE_PREFIX</span> <span class="token operator">=</span> <span class="token string">"debug"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MSG_TYPE_JSON</span> <span class="token operator">=</span> <span class="token string">"json"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MSG_TYPE_FORMATTED_STRING</span> <span class="token operator">=</span> <span class="token string">"formatted_string"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SELECTED_FIELDS</span> <span class="token operator">=</span> <span class="token string">"selectedFields"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_MSG_TYPE</span> <span class="token operator">=</span> <span class="token string">"msgType"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_WORK_DIR</span> <span class="token operator">=</span> <span class="token string">"workDir"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SUB_FILE_TYPE</span> <span class="token operator">=</span> <span class="token string">"subFileType"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_FILE_PREFIX</span> <span class="token operator">=</span> <span class="token string">"filePrefix"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">"fileSuffix"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SEPARATOR_NAME</span> <span class="token operator">=</span> <span class="token string">"separator"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SUB_FILE_INTERVAL</span> <span class="token operator">=</span> <span class="token string">"subFileInterval"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_RAWS_LIMIT_PER_FILE</span> <span class="token operator">=</span> <span class="token string">"rows.limit.per.file"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 全局配置
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_SYNC</span> <span class="token operator">=</span> <span class="token string">"sync"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_THREAD_NUM</span> <span class="token operator">=</span> <span class="token string">"threadNum"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ATTR_BLOCK</span> <span class="token operator">=</span> <span class="token string">"block"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SELECTED_FIELDS</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">MSG_TYPE</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">WORK_DIR</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">FILE_PREFIX</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">FILE_SUFFIX</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SUB_FILE_TYPE</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SYNC</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">THREAD_NUM</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">BLOCK</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SEPARATOR</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">SUB_FILE_INTERVAL</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AttrDescriptor</span> <span class="token constant">ROWS_LIMIT_PER_FILE</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrDescriptor</span><span class="token punctuation">></span></span> <span class="token constant">ATTR_DESCRIPTORS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 监控指标
     */</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_NAMESPACE</span> <span class="token operator">=</span> <span class="token string">"flowpipe"</span><span class="token punctuation">;</span>


    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token constant">SELECTED_FIELDS</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SELECTED_FIELDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">ARRAY</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"选择输出的字段列表,默认输出全部"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">MSG_TYPE</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_MSG_TYPE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">ENUM</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"输出消息格式，当前支持json和formatted_string"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">modifiable</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">MSG_TYPE_JSON</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token constant">MSG_TYPE_JSON</span><span class="token punctuation">,</span> <span class="token constant">MSG_TYPE_FORMATTED_STRING</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SEPARATOR</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SEPARATOR_NAME</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"分隔符，默认 |, 消息输出格式为formatted_string时有效"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">FILE_PREFIX</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_FILE_PREFIX</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"文件名前缀"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_FILE_PREFIX</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_FILE_SUFFIX</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"文件名后缀"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_FILE_SUFFIX</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SUB_FILE_TYPE</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SUB_FILE_TYPE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">ENUM</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"文件切分类型，默认不切分文件"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_DAY</span><span class="token punctuation">,</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_HOUR</span><span class="token punctuation">,</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_MINUTE</span><span class="token punctuation">,</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_SECOND</span><span class="token punctuation">,</span>
                        <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_NONE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">TIME_UNIT_NONE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SUB_FILE_INTERVAL</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SUB_FILE_INTERVAL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"文件切分间隔，默认为1，与切分类型配合使用"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_SUB_FILE_INTERVAL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">WORK_DIR</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_WORK_DIR</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"文件输出目录"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_WORK_DIR</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ROWS_LIMIT_PER_FILE</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_RAWS_LIMIT_PER_FILE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"单个文件的条数限制"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token constant">SYNC</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_SYNC</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">BOOL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"是否同步写入方式，默认为true"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">modifiable</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">THREAD_NUM</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_THREAD_NUM</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"异步写文件线程数"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">BLOCK</span> <span class="token operator">=</span> <span class="token class-name">AttrDescriptor</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token constant">ATTR_BLOCK</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataType</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">.</span><span class="token constant">BOOL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"写入是否阻塞"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">modifiable</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultValue</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SELECTED_FIELDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">MSG_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">FILE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SUB_FILE_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SUB_FILE_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">WORK_DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">ROWS_LIMIT_PER_FILE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SYNC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">THREAD_NUM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">BLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">DESCRIPTION</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">InputDescriptor</span> <span class="token function">inputDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">BASE_INPUT</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OutputDescriptor</span> <span class="token function">outputDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">BASE_OUTPUT</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MetaDescriptor</span> <span class="token function">metaDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">OperatorConstant</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_META</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrDescriptor</span><span class="token punctuation">></span></span> <span class="token function">attrDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">ATTR_DESCRIPTORS</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">FILE_CLOSE_WORKER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token number">1L</span><span class="token punctuation">,</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"file-close-worker"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 局部属性
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> selectedFields<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> filePrefix<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> fileSuffix<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msgType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> subFileType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> workDir<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> shutdown<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 全局属性
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Boolean</span> attrSync<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Boolean</span> attrBlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> threadNum<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WriteWorker</span><span class="token punctuation">></span></span> writeWorks<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">WriteWorker</span> syncWriteWorker<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MpscArrayQueue</span><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span><span class="token punctuation">></span></span> queues<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executor<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> separator<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> subFileInterval<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> rowsPerFile<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> deployCityCode<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterBCPCreate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterBCPClose<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterMainFileCreate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterMainFileClose<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterBCPBytes<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Counter</span> counterMainFileBytes<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Counter</span><span class="token punctuation">></span></span> <span class="token constant">COUNTER_ROSTER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">init0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        selectedFields <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getStringList</span><span class="token punctuation">(</span><span class="token constant">ATTR_SELECTED_FIELDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filePrefix <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_FILE_PREFIX</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_FILE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileSuffix <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_FILE_SUFFIX</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msgType <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_MSG_TYPE</span><span class="token punctuation">,</span> <span class="token constant">MSG_TYPE_JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subFileType <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_SUB_FILE_TYPE</span><span class="token punctuation">,</span> <span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 校验当前目录是否存在，如果不存在则进行创建</span>
        workDir <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getStringOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_WORK_DIR</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_WORK_DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token constant">ATTR_MSG_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">MSG_TYPE_FORMATTED_STRING</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            separator <span class="token operator">=</span> <span class="token class-name">StringEscapeUtils</span><span class="token punctuation">.</span><span class="token function">unescapeJava</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token constant">ATTR_SEPARATOR_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"separator参数缺失"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">checkForCreateDir</span><span class="token punctuation">(</span>workDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        subFileInterval <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getIntOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_SUB_FILE_INTERVAL</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_SUB_FILE_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rowsPerFile <span class="token operator">=</span> attrsDefine<span class="token punctuation">.</span><span class="token function">getIntOrDefault</span><span class="token punctuation">(</span><span class="token constant">ATTR_RAWS_LIMIT_PER_FILE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//bcpcount</span>
        <span class="token class-name">String</span> counterKeyBCPCreate <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span> filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyBCPClose <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span> filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyMainFileCreate <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span> filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyMainFileClose <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span> filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyBCP <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span>filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> counterKeyMainFile <span class="token operator">=</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">,</span>filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        counterBCPCreate <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyBCPCreate<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
           <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_create"</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyBCPCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterBCPClose <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyBCPClose<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
           <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_close"</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyBCPClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterMainFileCreate <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyMainFileCreate<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_create"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyMainFileCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterMainFileClose <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyMainFileClose<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_close"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyMainFileClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterBCPBytes <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyBCP<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span>  <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_bcp_bytes"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyBCP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counterMainFileBytes <span class="token operator">=</span> <span class="token constant">COUNTER_ROSTER</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>counterKeyMainFile<span class="token punctuation">,</span> s <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token class-name">Counter<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESPACE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>filePrefix <span class="token operator">+</span> <span class="token string">"_mainfile_bytes"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span>counterKeyMainFile<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">labelNames</span><span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">)</span>    <span class="token punctuation">;</span>
            <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">initOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 执行只初始化一次的任务
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">initOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">INIT_ONCE</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//非同步的方式需要创建线程来进行数据写入</span>
            attrSync <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token constant">ATTR_SYNC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>attrSync<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                threadNum <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token constant">ATTR_THREAD_NUM</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                attrBlock <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>attrsDefine<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token constant">ATTR_BLOCK</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 根据threadNum 初始化线程</span>
                executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>threadNum<span class="token punctuation">,</span> threadNum<span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"file-write-worker"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                queues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                writeWorks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">10240</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    queues<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">WriteWorker</span> writeWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteWorker</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writeWorks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>writeWorker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>writeWorker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                syncWriteWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getCounterKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getGaugeKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">AbstractNativeMsg</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">FileWriterItem</span> writerItem <span class="token operator">=</span> <span class="token function">genWriteItem</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attrSync<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">writeSync</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">writeAsync</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeSync</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用当前线程写入</span>
        syncWriteWorker<span class="token punctuation">.</span><span class="token function">tryWrite2File</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeAsync</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sleep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> <span class="token constant">TOTAL</span><span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>total <span class="token operator">%</span> threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> queues<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 临时打印 == > 修改时间自适应打印。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>total <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">100_000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===>>> FileWriter消费队列中元素个数为：{}"</span><span class="token punctuation">,</span> <span class="token class-name">Joiner</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>queues<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Queue</span><span class="token operator">::</span><span class="token function">size</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// block 为true 代表不能丢消息，需要阻塞等待队列有容量能够放入当前消息</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attrBlock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token operator">++</span>sleep<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">exceptionHandle</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exceptionHandle</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遇到中断异常，需要关闭当前写线程</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token class-name">FileWriterItem</span> <span class="token function">genWriteItem</span><span class="token punctuation">(</span><span class="token class-name">AbstractNativeMsg</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">FileWriterItem</span> writerItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriterItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 但是使用的是一份局部拷贝的新对象</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">partialClone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setFilePrefix</span><span class="token punctuation">(</span>filePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setFileSuffix</span><span class="token punctuation">(</span>fileSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setSubFileType</span><span class="token punctuation">(</span>subFileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setWorkDir</span><span class="token punctuation">(</span>workDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setSelectedFields</span><span class="token punctuation">(</span>selectedFields<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setMsgType</span><span class="token punctuation">(</span>msgType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setSep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setSubFileInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subFileInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setRowsPerFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rowsPerFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//monitor</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterBCPCreate</span><span class="token punctuation">(</span>counterBCPCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterBCPClose</span><span class="token punctuation">(</span>counterBCPClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterMainFileCreate</span><span class="token punctuation">(</span>counterMainFileCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterMainFileClose</span><span class="token punctuation">(</span>counterMainFileClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterBCPBytes</span><span class="token punctuation">(</span>counterBCPBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerItem<span class="token punctuation">.</span><span class="token function">setCounterMainFileBytes</span><span class="token punctuation">(</span>counterMainFileBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> writerItem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 检查或创建文件夹
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">checkForCreateDir</span><span class="token punctuation">(</span><span class="token class-name">String</span> dirName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dirName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            file<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shutdown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writeWorks <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>writeWorks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            writeWorks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">WriteWorker</span><span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//******************************************************************************************************************//</span>
    <span class="token comment">//********************************************   WRITE  THREAD  START   ********************************************//</span>
    <span class="token comment">//******************************************************************************************************************//</span>

    <span class="token comment">/**
     * debug 日志写线程
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteWorker</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WORKER_STATUS_NEW</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WORKER_STATUS_RUNNING</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WORKER_STATUS_EXIT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WAITING_MAX_TIMES</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW_FILE_FILED</span> <span class="token operator">=</span> <span class="token string">"_RAW_FILE_FIELD"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW_FILE_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW_FILE_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW1_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW1_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW2_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW2_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW1_BASE64_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW1_BASE64_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RAW2_BASE64_ENABLE</span> <span class="token operator">=</span> <span class="token string">"_RAW2_BASE64_ENABLE"</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TWO_LINE_SEP</span> <span class="token operator">=</span> <span class="token string">"\n\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FILE_NAME_SEPARATOR</span> <span class="token operator">=</span> <span class="token string">"-"</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringBuilder</span><span class="token punctuation">></span></span> <span class="token constant">STRING_BUILDER_THREAD_LOCAL</span> <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">AtomicBoolean</span> shutdown <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span></span> queue<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> fileCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MultiKeyMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WriterWrapper</span><span class="token punctuation">></span></span> writerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiKeyMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> mainFileCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> deployCityCode<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Boolean</span> prometheusEnable <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token class-name">Env</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token constant">PROMETHEUS_MONITOR_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">public</span> <span class="token class-name">WriteWorker</span><span class="token punctuation">(</span><span class="token class-name">MpscArrayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileWriterItem</span><span class="token punctuation">></span></span> queue<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">WORKER_STATUS_NEW</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取不成部署的地市区域编码</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>deployCityCode <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token class-name">Env</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token constant">DEPLOY_CITY_CODE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">"null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> sleep <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            status <span class="token operator">=</span> <span class="token constant">WORKER_STATUS_RUNNING</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>shutdown<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">boolean</span> success <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">tryWrite2File</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success <span class="token operator">&amp;&amp;</span> queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>sleep<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        sleep <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"write thread error: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// todo 异常处理，挂掉当前线程。</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            status <span class="token operator">=</span> <span class="token constant">WORKER_STATUS_EXIT</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"FileWrite Thread exit, stop:{}, interrupted:{}"</span><span class="token punctuation">,</span> shutdown<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果 queue 中还有数据，尝试将剩余的数据写入到文件中</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}开始执行关闭逻辑"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"file-write-worker-[{}]缓存队列非空，剩余日志数：[{}], 尝试将队列中数据写入文件"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    queue<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">tryWrite2File</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">MultiKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">WriterWrapper</span><span class="token punctuation">></span><span class="token punctuation">></span></span> iterator <span class="token operator">=</span> writerMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MultiKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">WriterWrapper</span><span class="token punctuation">></span></span> next <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">WriterWrapper</span> wrapper <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 关闭时使用同步方式进行关闭</span>
                        wrapper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterBCPClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterBCPBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// 关闭后将元素移除</span>
                        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"进程关闭，关闭文件[{}]出现异常："</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}关闭异常："</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shutdown<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> times <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 等待worker 线程正常退出或者达到最大等待时长</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token constant">WORKER_STATUS_EXIT</span> <span class="token operator">||</span> times <span class="token operator">>=</span> <span class="token constant">WAITING_MAX_TIMES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        times<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"file-write-worker-{}关闭异常："</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token comment">/**
         * 执行写文件逻辑
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">tryWrite2File</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODO 待优化 当前依靠新的日志来触发文件切换的条件</span>
            <span class="token class-name">WriterWrapper</span> wrapper <span class="token operator">=</span> <span class="token function">getWriterOrCreate</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果被重置了，需要再次获取wrapper</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">resetWriterIfNeed</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    wrapper <span class="token operator">=</span> <span class="token function">getWriterOrCreate</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 处理原始码流文件</span>
                    <span class="token function">dealWithRawFile</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 写入bcp文件</span>
                    <span class="token class-name">String</span> writeMsg <span class="token operator">=</span> <span class="token function">genWriteMsg</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>writeMsg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        wrapper<span class="token punctuation">.</span><span class="token function">writeRow</span><span class="token punctuation">(</span>writeMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 暂时不需要重置 MAINFILE 字段，当前msg对象是一份拷贝，新增字段不会影响原对象</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"写入内容异常, fileName:[{}], error"</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 生成mainfile
         *
         * @param writerItem
         * @param wrapper
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dealWithRawFile</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">,</span> <span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AbstractNativeMsg</span> msg <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> rawFileEnable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW_FILE_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rawFileEnable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>rawFileEnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Boolean</span> raw1Enable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW1_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> raw2Enable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW2_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> raw1Base64Enable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW1_BASE64_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> raw2Base64Enable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW2_BASE64_ENABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 至少需要开启一个选项才进行写入</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>raw1Enable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>raw1Enable<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>raw2Enable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>raw2Enable<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>raw1Base64Enable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>raw1Base64Enable<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>raw2Base64Enable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>raw2Base64Enable<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//打点记一次</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">FixedFieldDict</span><span class="token punctuation">.</span><span class="token constant">RAW_1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">FixedFieldDict</span><span class="token punctuation">.</span><span class="token constant">RAW_2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> rawFileField <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW_FILE_FILED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 原始码流都不存在的情况下也不需要写mainfile</span>
            <span class="token comment">// 如果已经填了mainfile,则需要处理(复制文件到正确的地方)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">rawDataEnable</span><span class="token punctuation">(</span>raw1<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">rawDataEnable</span><span class="token punctuation">(</span>raw2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">try2HandleMainFile</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">,</span> wrapper<span class="token punctuation">,</span> raw1Enable<span class="token punctuation">,</span> raw2Enable<span class="token punctuation">,</span> raw1Base64Enable<span class="token punctuation">,</span> raw2Base64Enable<span class="token punctuation">,</span> raw1<span class="token punctuation">,</span> raw2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">try2HandleMainFile</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">,</span>
                                        <span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">,</span>
                                        <span class="token class-name">Boolean</span> raw1Enable<span class="token punctuation">,</span>
                                        <span class="token class-name">Boolean</span> raw2Enable<span class="token punctuation">,</span>
                                        <span class="token class-name">Boolean</span> raw1Base64Enable<span class="token punctuation">,</span>
                                        <span class="token class-name">Boolean</span> raw2Base64Enable<span class="token punctuation">,</span>
                                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw1<span class="token punctuation">,</span>
                                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当前 mainfile 跟 bcp  文件在同一目录下，去除.bcp后缀的文件名作为rawFile的目录</span>
            <span class="token class-name">String</span> filePath <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> indexOf <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> mainFilePath <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> indexOf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> mainFileDir <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mainFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mainFileDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mainFileDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> mainFileName <span class="token operator">=</span> <span class="token function">genMainFileName</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> mainFile <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mainFileDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mainFileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> rawFileField <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">RAW_FILE_FILED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rawFileField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> existMainFilePath <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>existMainFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>existMainFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">String</span> existMainFileName <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">String</span> existMainFileSuffix <span class="token operator">=</span> existMainFileName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> existMainFileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>existMainFileName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
                            <span class="token class-name">String</span> targetMainFileName <span class="token operator">=</span> mainFileName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> mainFileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> mainFileName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> mainFileName<span class="token punctuation">;</span>
                            mainFile <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mainFileDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetMainFileName <span class="token operator">+</span> existMainFileSuffix<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">FileUtil</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> mainFile<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//mainfile复制了一次，打点</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                                wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">labels</span><span class="token punctuation">(</span><span class="token string">"COPY"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span>mainFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mainFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">,</span> mainFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"rawFileField:{} has content:{} but no file exist"</span><span class="token punctuation">,</span> rawFileField<span class="token punctuation">,</span> existMainFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileWriter</span> mainFileWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>mainFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">//加了一个counter</span>
                            <span class="token function">writeMainFileContent</span><span class="token punctuation">(</span>mainFileWriter<span class="token punctuation">,</span> raw1Enable<span class="token punctuation">,</span> raw2Enable<span class="token punctuation">,</span> raw1Base64Enable<span class="token punctuation">,</span> raw2Base64Enable<span class="token punctuation">,</span> raw1<span class="token punctuation">,</span> raw2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            mainFileWriter<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">//mainfile写了一个，打点</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterMainFileBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">labels</span><span class="token punctuation">(</span><span class="token string">"WRITE"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span>mainFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 进行 原始码流文件字段 赋值</span>
                    writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rawFileField<span class="token punctuation">,</span> mainFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"写MAINFILE异常，filePrefix:[{}], 异常："</span><span class="token punctuation">,</span> writerItem<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeMainFileContent</span><span class="token punctuation">(</span><span class="token class-name">FileWriter</span> fileWriter<span class="token punctuation">,</span>
                                          <span class="token class-name">Boolean</span> raw1Enable<span class="token punctuation">,</span>
                                          <span class="token class-name">Boolean</span> raw2Enable<span class="token punctuation">,</span>
                                          <span class="token class-name">Boolean</span> raw1Base64Enable<span class="token punctuation">,</span>
                                          <span class="token class-name">Boolean</span> raw2Base64Enable<span class="token punctuation">,</span>
                                          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw1<span class="token punctuation">,</span>
                                          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rawDataEnable</span><span class="token punctuation">(</span>raw1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>raw1Enable <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw1Enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>raw1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">TWO_LINE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>raw1Base64Enable <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw1Base64Enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> raw1Base64 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>raw1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>raw1Base64<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">TWO_LINE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rawDataEnable</span><span class="token punctuation">(</span>raw2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>raw2Enable <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw2Enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>raw2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">TWO_LINE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>raw2Base64Enable <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw2Base64Enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> raw2Base64 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>raw2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>raw2Base64<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">TWO_LINE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">rawDataEnable</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> raw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> raw <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> raw<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">genMainFileName</span><span class="token punctuation">(</span><span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"_raw_"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mainFileCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">".txt"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token class-name">WriterWrapper</span> <span class="token function">getWriterOrCreate</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 根据前缀和后缀获取，如果没有则新建</span>
            <span class="token class-name">WriterWrapper</span> wrapper <span class="token operator">=</span> writerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> writerItem<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//wrapper = WriterWrapper.from(writerItem, index, fileCount.getAndIncrement(), true);</span>
                    <span class="token class-name">String</span> fileNameForTJ <span class="token operator">=</span> <span class="token function">genFileNameForTJ</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    wrapper <span class="token operator">=</span> <span class="token class-name">WriterWrapper</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">,</span> fileNameForTJ<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//新建了bcp文件，打点</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        writerItem<span class="token punctuation">.</span><span class="token function">getCounterBCPCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        writerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> writerItem<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"获取writerWrapper异常，data:[{}], error:"</span><span class="token punctuation">,</span> writerItem<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> wrapper<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">resetWriterIfNeed</span><span class="token punctuation">(</span><span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">isExpire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// rest the cached map</span>
                writerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">tryFlush</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">tryFlush</span><span class="token punctuation">(</span><span class="token class-name">WriterWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wrapper<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">FILE_CLOSE_WORKER</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        wrapper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//同步消息</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prometheusEnable<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterBCPClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">getCounterBCPBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"try flush file close writer error: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">genWriteMsg</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msgType <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsgType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msgType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">MSG_TYPE_JSON</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">jsonTypeMsg</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token constant">MSG_TYPE_FORMATTED_STRING</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">formattedTypeMsg</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">formattedTypeMsg</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> selectedFields <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getSelectedFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedFields<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token class-name">AbstractNativeMsg</span> msg <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token constant">STRING_BUILDER_THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringBuilder<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> selectedFields<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> name <span class="token operator">=</span> selectedFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Object</span> value <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token function">replaceSensitiveChars</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getSep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span> finalValue <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>selectedFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>selectedFields<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token function">replaceSensitiveChars</span><span class="token punctuation">(</span>finalValue<span class="token punctuation">,</span> writerItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">replaceSensitiveChars</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> part <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            if (part.contains(writerItem.getSep())) {</span>
<span class="token comment">//                part = part.replaceAll(writerItem.getSep(), URLUtil.encode(writerItem.getSep()));</span>
<span class="token comment">//            }</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                part <span class="token operator">=</span> part<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">,</span> <span class="token string">"\\\\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"\r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                part <span class="token operator">=</span> part<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\r"</span><span class="token punctuation">,</span> <span class="token string">"\\\\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                part <span class="token operator">=</span> part<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"\\\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> part<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">jsonTypeMsg</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> selectedFields <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getSelectedFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AbstractNativeMsg</span> msg <span class="token operator">=</span> writerItem<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JSONObject</span> logItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>selectedFields<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> selectedField <span class="token operator">:</span> selectedFields<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logItem<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>selectedField<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>selectedField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> logItem<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">/**
         * 根据TJ的规范生成fileName
         * 生成规则：
         * &lt;pre>
         *     第一个固定111，第二个是地市区域编码，第三个是生成时间戳，第四个是随机数，第五个是大写类型名，第六个0.xx1_bq保留不动
         *     示例：111-511100-1620575830-06580-DATA_IM-0.xx1_bq.bcp
         * &lt;/pre>
         *
         * @return
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">genFileNameForTJ</span><span class="token punctuation">(</span><span class="token class-name">FileWriterItem</span> writerItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>deployCityCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>fileCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getFilePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">FILE_NAME_SEPARATOR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"xx1_bq"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>writerItem<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//******************************************************************************************************************//</span>
    <span class="token comment">//********************************************   WRITE  THREAD   END    ********************************************//</span>
    <span class="token comment">//******************************************************************************************************************//</span>


<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/c7d949f743bc47019ba33d161d18b6da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这里面生成了一个静态内部类，用非阻塞、异步的方式处理IO。</span></span></p></div></article>
  <footer class="Footer">
  <div>&copy; NorthWind 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>